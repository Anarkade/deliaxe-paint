class x{buffer;position;constructor(){this.buffer=new Uint8Array(0),this.position=0}crc32(t){let e=-1;for(let n=0;n<t.length;n++)e=e>>>8^this.crc32Table[(e^t[n])&255];return e^-1}crc32Table=(()=>{const t=new Uint32Array(256);for(let e=0;e<256;e++){let n=e;for(let s=0;s<8;s++)n=n&1?3988292384^n>>>1:n>>>1;t[e]=n}return t})();writeBytes(t){const e=new Uint8Array(this.buffer.length+t.length);e.set(this.buffer),e.set(t,this.buffer.length),this.buffer=e,this.position+=t.length}writeUint32BE(t){const e=new Uint8Array(4);e[0]=t>>>24&255,e[1]=t>>>16&255,e[2]=t>>>8&255,e[3]=t&255,this.writeBytes(e)}writeChunk(t,e){this.writeUint32BE(e.length);const n=new TextEncoder().encode(t);this.writeBytes(n),this.writeBytes(e);const s=new Uint8Array(n.length+e.length);s.set(n),s.set(e,n.length),this.writeUint32BE(this.crc32(s))}createIHDRChunk(t,e){const n=new Uint8Array(13),s=new DataView(n.buffer);return s.setUint32(0,t,!1),s.setUint32(4,e,!1),n[8]=8,n[9]=3,n[10]=0,n[11]=0,n[12]=0,n}createPLTEChunk(t){const e=new Uint8Array(t.length*3);for(let n=0;n<t.length;n++)e[n*3]=t[n].r,e[n*3+1]=t[n].g,e[n*3+2]=t[n].b;return e}createTRNSChunk(t){const e=t.map(s=>s.a!==void 0?s.a:255);return e.some(s=>s<255)?new Uint8Array(e):null}deflate(t){const n=[];let s=0;for(;s<t.length;){const o=Math.min(65535,t.length-s),y=s+o>=t.length,u=new Uint8Array(5+o);u[0]=y?1:0,u[1]=o&255,u[2]=o>>8&255,u[3]=~o&255,u[4]=~o>>8&255,u.set(t.subarray(s,s+o),5),n.push(u),s+=o}const h=n.reduce((o,y)=>o+y.length,0),c=new Uint8Array(2+h+4);c[0]=120,c[1]=1;let l=2;for(const o of n)c.set(o,l),l+=o.length;let f=1,i=0;for(let o=0;o<t.length;o++)f=(f+t[o])%65521,i=(i+f)%65521;const a=i<<16|f;return c[l]=a>>>24&255,c[l+1]=a>>>16&255,c[l+2]=a>>>8&255,c[l+3]=a&255,c}createIDATChunk(t,e){const{width:n,height:s}=t,h=t.data,c=new Map;e.forEach((f,i)=>{const a=`${f.r},${f.g},${f.b}`;c.set(a,i)});const l=new Uint8Array(s*(n+1));for(let f=0;f<s;f++){l[f*(n+1)]=0;for(let i=0;i<n;i++){const a=(f*n+i)*4,o=h[a],y=h[a+1],u=h[a+2],U=`${o},${y},${u}`;let g=c.get(U);if(g===void 0){let b=1/0;g=0;for(let p=0;p<e.length;p++){const I=e[p].r,B=e[p].g,C=e[p].b,d=Math.sqrt((o-I)**2+(y-B)**2+(u-C)**2);d<b&&(b=d,g=p)}}l[f*(n+1)+i+1]=g}}return this.deflate(l)}encodePNG8(t,e){this.buffer=new Uint8Array(0),this.position=0;const n=new Uint8Array([137,80,78,71,13,10,26,10]);this.writeBytes(n);const s=this.createIHDRChunk(t.width,t.height);this.writeChunk("IHDR",s);const h=this.createPLTEChunk(e);this.writeChunk("PLTE",h);const c=this.createTRNSChunk(e);c&&this.writeChunk("tRNS",c);const l=this.createIDATChunk(t,e);return this.writeChunk("IDAT",l),this.writeChunk("IEND",new Uint8Array(0)),this.buffer}}function R(r,t){const n=new x().encodePNG8(r,t);return new Blob([n],{type:"image/png"})}const T=new Uint8Array([137,80,78,71,13,10,26,10]);function w(r,t){return r[t]<<24|r[t+1]<<16|r[t+2]<<8|r[t+3]}function k(r){return new Promise((t,e)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=e,n.readAsArrayBuffer(r)})}function P(r){const t=r.split(",")[1],e=atob(t),n=new Uint8Array(e.length);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return n.buffer}function D(r){if(r.length<8)return!1;for(let t=0;t<8;t++)if(r[t]!==T[t])return!1;return!0}function G(r){const t=[];let e=8;for(;e<r.length&&!(e+8>r.length);){const n=w(r,e),s=String.fromCharCode(...r.slice(e+4,e+8));if(e+8+n+4>r.length)break;const h=r.slice(e+8,e+8+n),c=w(r,e+8+n);if(t.push({length:n,type:s,data:h,crc:c}),e+=8+n+4,s==="IEND")break}return t}function m(r){return{width:w(r,0),height:w(r,4),bitDepth:r[8],colorType:r[9],compression:r[10],filter:r[11],interlace:r[12]}}function N(r){const t=[];for(let e=0;e<r.length;e+=3)e+2<r.length&&t.push({r:r[e],g:r[e+1],b:r[e+2]});return t}async function A(r){try{let t;if(typeof r=="string")if(r.startsWith("data:image/png"))t=P(r);else return{format:"PNG",isIndexed:!1};else{if(!r.type.includes("png"))return{format:r.type.split("/")[1]?.toUpperCase()||"Unknown",isIndexed:!1};t=await k(r)}const e=new Uint8Array(t);if(!D(e))return{format:"PNG",isIndexed:!1};const n=G(e),s=n.find(i=>i.type==="IHDR"),h=n.find(i=>i.type==="PLTE"),c=n.find(i=>i.type==="tRNS");if(!s)return{format:"PNG",isIndexed:!1};const l=m(s.data),f=!!c;if(l.colorType===3&&h){const a=N(h.data).length;return{format:`PNG-${l.bitDepth<=8&&a<=256?"8":"24"} Indexed (${a} colors palette)`,isIndexed:!0,paletteSize:a,bitDepth:l.bitDepth}}else{let i="PNG-24 RGB";switch(l.colorType){case 0:i=l.bitDepth<=8?"PNG-8 Grayscale":"PNG-16 Grayscale";break;case 2:i="PNG-24 RGB";break;case 4:i="PNG-16 Grayscale+Alpha";break;case 6:i="PNG-32 RGBA";break}return{format:i,isIndexed:!1,bitDepth:l.bitDepth}}}catch(t){return console.error("Error analyzing PNG file:",t),{format:"PNG",isIndexed:!1}}}async function E(r){try{if(!(await A(r)).isIndexed)return null;let e;if(typeof r=="string")if(r.startsWith("data:image/png"))e=P(r);else return null;else e=await k(r);const n=new Uint8Array(e),h=G(n).find(c=>c.type==="PLTE");return h?N(h.data):null}catch(t){return console.error("Error extracting PNG palette:",t),null}}const S=Object.freeze(Object.defineProperty({__proto__:null,analyzePNGFile:A,extractPNGPalette:E},Symbol.toStringTag,{value:"Module"}));export{R as c,S as p};
//# sourceMappingURL=image-processing-DfJTan-A.js.map
