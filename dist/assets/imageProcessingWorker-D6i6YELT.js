(function(){"use strict";const E=(i,g,r)=>{const e=Math.round(i/255*7),a=Math.round(g/255*7),t=Math.round(r/255*7);return{r:Math.round(e/7*255),g:Math.round(a/7*255),b:Math.round(t/7*255)}},C=(i,g)=>{const t=i.r-g.r,s=i.g-g.g,c=i.b-g.b;return Math.sqrt(.3*t*t+.59*s*s+.11*c*c)},b=(i,g)=>{if(i.length<=g)return i;i.sort((e,a)=>(a.count||0)-(e.count||0));const r=[i];for(;r.length<g;){let e=0,a=0;for(let l=0;l<r.length;l++){const u=r[l];if(u.length<=1)continue;const w=Math.max(...u.map(h=>h.r))-Math.min(...u.map(h=>h.r)),A=Math.max(...u.map(h=>h.g))-Math.min(...u.map(h=>h.g)),S=Math.max(...u.map(h=>h.b))-Math.min(...u.map(h=>h.b)),P=Math.max(w,A,S);P>a&&(a=P,e=l)}if(a===0)break;const t=r[e],s=Math.max(...t.map(l=>l.r))-Math.min(...t.map(l=>l.r)),c=Math.max(...t.map(l=>l.g))-Math.min(...t.map(l=>l.g)),n=Math.max(...t.map(l=>l.b))-Math.min(...t.map(l=>l.b));let o;s>=c&&s>=n?o="r":c>=n?o="g":o="b",t.sort((l,u)=>l[o]-u[o]);const m=Math.floor(t.length/2),p=t.slice(0,m),d=t.slice(m);r[e]=p,r.push(d)}return r.map(e=>{const a=e.reduce((n,o)=>n+(o.count||1),0),t=e.reduce((n,o)=>n+o.r*(o.count||1),0)/a,s=e.reduce((n,o)=>n+o.g*(o.count||1),0)/a,c=e.reduce((n,o)=>n+o.b*(o.count||1),0)/a;return{r:Math.round(t),g:Math.round(s),b:Math.round(c),count:a}})},f=i=>{const g=new Map,r=i.data;for(let e=0;e<r.length;e+=4){const a=r[e],t=r[e+1],s=r[e+2];if(r[e+3]>0){const n=`${a},${t},${s}`;g.set(n,(g.get(n)||0)+1)}}return Array.from(g.entries()).map(([e,a])=>{const[t,s,c]=e.split(",").map(Number);return{r:t,g:s,b:c,count:a}})},M=(i,g)=>{const r=i.data,e=new ImageData(new Uint8ClampedArray(r),i.width,i.height),a=e.data;for(let t=0;t<r.length;t+=4){const s=r[t],c=r[t+1],n=r[t+2],o=r[t+3];if(o>0){let m=g[0],p=1/0;for(const d of g){const l=C({r:s,g:c,b:n},d);l<p&&(p=l,m=d)}a[t]=m.r,a[t+1]=m.g,a[t+2]=m.b,a[t+3]=o}else a[t]=s,a[t+1]=c,a[t+2]=n,a[t+3]=o}return e},y=(i,g,r={})=>{switch(g){case"EXTRACT_COLORS":return f(i);case"QUANTIZE_COLORS":{const{colors:e,targetCount:a}=r;return b(e||[],a||16)}case"APPLY_PALETTE":{const{palette:e}=r;return M(i,e||[])}case"MEGA_DRIVE_PROCESS":{const{originalPalette:e}=r;return R(i)}}},R=(i,g)=>{f(i);const r=new ImageData(new Uint8ClampedArray(i.data),i.width,i.height),e=r.data,a=e.length/4;for(let n=0;n<e.length;n+=4){if(e[n+3]>0){const m=E(e[n],e[n+1],e[n+2]);e[n]=m.r,e[n+1]=m.g,e[n+2]=m.b}const o=Math.max(1,Math.floor(a/10));if(n>0&&n/4%o===0){const m=Math.floor(n/4/a*50);self.postMessage({type:"PROCESSING_PROGRESS",progress:m,id:"current"})}}const t=f(r);let s;for(t.length<=16?s=t:s=b(t,16),s=s.map(n=>{const o=n,m=typeof o.r=="number"?o.r:0,p=typeof o.g=="number"?o.g:0,d=typeof o.b=="number"?o.b:0;return E(m,p,d)});s.length<16;)s.push({r:0,g:0,b:0,count:0});return s=s.slice(0,16),{imageData:M(r,s),palette:s}};self.addEventListener("message",i=>{const{type:g,data:r,id:e}=i.data;try{let a;const t=r||{};switch(g){case"PROCESS_IMAGE":{const c=t.imageData,n=typeof t.operation=="string"?t.operation:"",o=t.options||{};if(!c)throw new Error("Missing imageData for PROCESS_IMAGE");a=y(c,n,o);break}case"QUANTIZE_COLORS":{const c=Array.isArray(t.colors)?t.colors:[],n=typeof t.targetCount=="number"?t.targetCount:Number(t.targetCount)||16;a=b(c,n);break}case"APPLY_PALETTE":{const c=t.imageData,n=Array.isArray(t.palette)?t.palette:[];if(!c)throw new Error("Missing imageData for APPLY_PALETTE");a=M(c,n);break}case"EXTRACT_COLORS":{const c=t.imageData;if(!c)throw new Error("Missing imageData for EXTRACT_COLORS");a=f(c);break}case"MEGA_DRIVE_PROCESS":{const c=t.imageData,n=Array.isArray(t.originalPalette)?t.originalPalette:void 0,o=n?n.map(m=>({r:m.r,g:m.g,b:m.b})):void 0;if(!c)throw new Error("Missing imageData for MEGA_DRIVE_PROCESS");a=R(c,o);break}default:throw new Error(`Unknown message type: ${g}`)}const s={type:"PROCESSING_COMPLETE",data:a,id:e};self.postMessage(s)}catch(a){const s={type:"PROCESSING_ERROR",data:a instanceof Error?{message:a.message,stack:a.stack}:{message:String(a)},id:e};self.postMessage(s)}})})();
//# sourceMappingURL=imageProcessingWorker-D6i6YELT.js.map
